# MTran System Communication Theory

## 1. What the System Requires from the App

### Device Registration
```
POST /functions/v1/auth-proxy
Body: { action: "register", device_id, device_name, device_model, os_version, app_version }
Response: { success, device_token, client_id }
```

### Transaction Upload
```
POST /functions/v1/clean-mpesa
Headers: { Authorization: "Bearer <ANON_KEY>", x-device-token: "<device_token>" }
Body: { raw_message, transaction_timestamp, client_id, client_tx_id }
Response: { success, transaction: {...}, uploaded_at }
```

### Required Fields per Transaction
| Field | Type | Description |
|-------|------|-------------|
| `raw_message` | string | Original M-PESA SMS text |
| `transaction_timestamp` | number | Unix epoch (seconds) |
| `client_id` | string | Device identifier |
| `client_tx_id` | string | UUID generated by app |

---

## 2. Data Flow Architecture

```
┌─────────────┐     HTTPS/REST      ┌──────────────────┐
│  Android    │ ──────────────────► │  Edge Functions  │
│    App      │                     │  (auth-proxy,    │
│             │ ◄────────────────── │   clean-mpesa)   │
└─────────────┘     JSON Response   └────────┬─────────┘
                                             │
                                             ▼
                                    ┌──────────────────┐
                                    │    PostgreSQL    │
                                    │  (mpesa_trans,   │
                                    │   mobile_clients)│
                                    └────────┬─────────┘
                                             │
                                             ▼
                                    ┌──────────────────┐
                                    │  React Dashboard │
                                    │  (Realtime Sub)  │
                                    └──────────────────┘
```

---

## 3. App → System Triggers

| Action | Endpoint | Trigger |
|--------|----------|---------|
| Register device | `auth-proxy` | First app launch |
| Upload transaction | `clean-mpesa` | SMS received |
| Batch sync | `clean-mpesa` | Connectivity restored |
| Heartbeat | `auth-proxy` | Periodic (every 15min) |

### Batch Upload Format
```json
{
  "records": [
    { "raw_message": "...", "transaction_timestamp": 1234567890, "client_tx_id": "uuid-1" },
    { "raw_message": "...", "transaction_timestamp": 1234567891, "client_tx_id": "uuid-2" }
  ],
  "client_id": "device-uuid"
}
```

---

## 4. System → App Triggers

### Option A: Polling (Current)
App polls for updates periodically:
```
GET /rest/v1/mobile_clients?device_id=eq.<device_id>&select=is_active,last_sync_at
```

### Option B: Push Notifications (Future)
System sends FCM push to trigger app actions:
- Force sync
- Config update
- Deactivation notice

### Option C: Realtime WebSocket (Advanced)
```typescript
supabase.channel('device-commands')
  .on('broadcast', { event: 'sync-now' }, () => triggerSync())
  .subscribe()
```

---

## 5. Deduplication Strategy

```
1. App generates UUID → client_tx_id
2. App includes raw_message hash
3. Backend checks: UNIQUE(client_id, raw_message)
4. If duplicate → returns existing transaction
5. If new → AI parses, stores, returns result
```

---

## 6. Offline Resilience

```
┌─────────────────────────────────────────────────────┐
│                    ANDROID APP                       │
├─────────────────────────────────────────────────────┤
│  SMS Received → Room DB (local) → Upload Queue      │
│                      ↓                               │
│            Connectivity Check                        │
│                 ↓         ↓                          │
│            ONLINE      OFFLINE                       │
│               ↓           ↓                          │
│         POST to Edge   Queue in Room                 │
│               ↓           ↓                          │
│          Clear Queue   Retry on reconnect            │
└─────────────────────────────────────────────────────┘
```

---

## 7. Authentication Flow

```
1. App starts → Check local device_token
2. If none → POST auth-proxy { action: "register" }
3. Store device_token locally
4. All subsequent requests include x-device-token header
5. Backend validates token against mobile_clients table
```

---

## 8. Response Codes

| Code | Meaning | App Action |
|------|---------|------------|
| 200 | Success | Clear from queue |
| 201 | Created | Clear from queue |
| 409 | Duplicate | Clear from queue |
| 401 | Invalid token | Re-register |
| 429 | Rate limited | Exponential backoff |
| 5xx | Server error | Retry with backoff |
